// Generated by CoffeeScript 1.4.0

/*
RECORDING
*/


(function() {
  var RECORDING_LIMIT, file_input, play, record, stop, timecode, upload;

  RECORDING_LIMIT = 10 * 1000;

  timecode = function(ms) {
    var hms, tc;
    hms = {
      h: Math.floor(ms / (60 * 60 * 1000)),
      m: Math.floor((ms / 60000) % 60),
      s: Math.floor(ms / 1000 % 60)
    };
    tc = [];
    if (hms.h > 0) {
      tc.push(hms.h);
    }
    tc.push(hms.m < 10 && hms.h > 0 ? "0" + hms.m : hms.m);
    tc.push(hms.s < 10 ? "0" + hms.s : hms.s);
    return tc.join(':');
  };

  Recorder.initialize({
    swfSrc: "/static/libs/recorder/recorder.swf"
  });

  record = function() {
    return Recorder.record({
      start: function() {
        document.getElementById('record_button').disabled = true;
        return document.getElementById("stop_button").disabled = false;
      },
      progress: function(milliseconds) {
        document.getElementById("time").innerHTML = timecode(milliseconds);
        if (milliseconds > RECORDING_LIMIT) {
          return Recorder.stop();
        }
      },
      cancel: function() {
        document.getElementById('record_button').disabled = false;
        return document.getElementById("stop_button").disabled = true;
      }
    });
  };

  play = function() {
    Recorder.stop();
    return Recorder.play({
      progress: function(milliseconds) {
        return document.getElementById('time').innerHTML = timecode(milliseconds);
      },
      finished: function() {}
    });
  };

  stop = function() {
    document.getElementById('record_button').disabled = false;
    document.getElementById("stop_button").disabled = true;
    Recorder.stop();
    return upload();
  };

  upload = function() {
    return Recorder.upload({
      url: "/",
      audioParam: "audio_file",
      success: function(response) {
        var track;
        window.n_channels = 1;
        track = $.parseJSON(response);
        return load_sound_file(track.filepath);
      }
    });
  };

  $('#record_button').click(function() {
    return record();
  });

  $('#play_button').click(function() {
    return play();
  });

  $('#stop_button').click(function() {
    return stop();
  });

  $('#upload_button').click(function() {
    return upload();
  });

  file_input = document.querySelector('input[type="file"]');

  file_input.addEventListener('change', function(e) {
    var reader;
    reader = new FileReader();
    reader.onload = function(e) {
      window.n_channels = 2;
      return init_sound(this.result);
    };
    return reader.readAsArrayBuffer(this.files[0]);
  }, false);

  $('#play_reversed').click(function() {
    stop_sound;
    return play_reversed();
  });

  $('#stop_sound').click(function() {
    return stop_sound();
  });

}).call(this);
